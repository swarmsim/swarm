<div class="row">
  <div class="col-sm-8 col-sm-push-4">
    <div ng-if="tutText()" class="animif">
      <p>{{tutText()}}</p>
      <hr>
    </div>
    <div ng-if="!selected">
      <p ng-if="welcomeBackText()">{{welcomeBackText()}}</p>
      <p>{{emptyText()}}</p>
    </div>
    <div ng-if="selected">
      <h2>{{selected.unittype.label}}</h2>
      <p title="{{selected.unittype.lol}}">{{selected.unittype.description}}</p>
      <hr>
      <p><ng-pluralize count="selected.count()"
        when="{'0':'You own no {{selected.unittype.plural}}.',
               'one':'You own 1 {{selected.unittype.label}}.',
               'other':'You own {{selected.count()|number:0}} {{selected.unittype.plural}}.'}"></ng-pluralize>
      <div ng-if="selected.prod.length">
        <p>
          Each produces
          <span ng-repeat="(name, val) in selected.eachProduction()">
            <span ng-if="!$first && !$last">, </span><span ng-if="!$first && $last"> and </span>
            <span ng-if="val < 0.2 && val > 0">1/{{1/val|number:0}} of a {{game.unit(name).unittype.label}}</span>
            <span ng-if="val <= 0 || val >= 0.2">{{decimals(val)|number}} <ng-pluralize count="val" when="{'one':game.unit(name).unittype.label, 'other':game.unit(name).unittype.plural}"></ng-pluralize></span>
          </span>
          per second.
          <span ng-if="selected.hasStat('base', 0)">(+{{selected.stat('base')|number:1}} bonus)</span>
          <span ng-if="selected.hasStat('prod', 1)">(x{{selected.stat('prod')|number:1}} bonus)</span>
        </p>
        <p ng-if="selected.count() > 0">
          In total, they produce
          <span ng-repeat="(name, val) in selected.totalProduction()">
            <span ng-if="!$first && !$last">, </span><span ng-if="!$first && $last"> and </span>
            <span ng-if="val < 0.2 && val > 0">1/{{1/val|number:0}} of a {{game.unit(name).unittype.label}}</span>
            <span ng-if="val <= 0 || val >= 0.2">{{decimals(val)|number}} <ng-pluralize count="val" when="{'one':game.unit(name).unittype.label, 'other':game.unit(name).unittype.plural}"></ng-pluralize></span>
          </span>
          per second.
        </p>
      </div>
      <div ng-if="selected.showparent && selected.showparent.prod.length">
        You earn
        <span ng-repeat="(name, val) in selected.showparent.totalProduction()">
          <span ng-if="!$first && !$last">, </span><span ng-if="!$first && $last"> and </span>
          <span ng-if="val < 0.2 && val > 0">1/{{1/val|number:0}} of a {{game.unit(name).unittype.label}}</span>
          <span ng-if="val <= 0 || val >= 0.2">{{decimals(val)|number}} <ng-pluralize count="val" when="{'one':game.unit(name).unittype.label, 'other':game.unit(name).unittype.plural}"></ng-pluralize></span>
        </span>
        per second.
        <span ng-if="selected.showparent.hasStat('base', 0)">(+{{selected.showparent.stat('base')|number:0}} bonus)</span>
        <span ng-if="selected.showparent.hasStat('prod', 1)">(x{{selected.showparent.stat('prod')|number:1}} bonus)</span>
      </div>
      <div ng-if="!selected.showparent && selected.velocity() > 0">
        You earn
        <span ng-if="selected.velocity() < 0.2 && selected.velocity() > 0">1/{{1/selected.velocity()|number:0}} of a {{selected.unittype.label}}</span>
        <!-- TODO why isn't ng-pluralize working here? Switching units keeps the same label. -->
        <span ng-if="selected.velocity() <= 0 || selected.velocity() >= 0.2">{{decimals(selected.velocity())|number}} {{selected.unittype.plural}}</span>
        per second.
      </div>
      <div ng-if="!selected.unbuyable && selected.cost.length">
        <hr>
        <!--div class="form-group">
          <label for="buyone">Buy one</label>
          <button id="buyone" ng-click="selected.buy(1)" class="form-control unit-buy" ng-disabled="!selected.isCostMet()">
            <span ng-repeat="cost in selected.cost">
              <span ng-class="{costNotMet:cost.val > cost.unit.count()}">{{cost.val|bignum}} {{cost.unit.unittype.plural}}</span><span ng-if="!$last">, </span>
            </span>
          </button>
        </div-->
        <div ng-if="selected.count() == 0 && selected.isCostMet()" ng-repeat="warn in (selected.warnfirst | filter:isWarningVisible)">
          <!-- nested div to get the animation right: disappear instantly when switching units, fade when closing manually -->
          <!-- TODO: too bad the "fade when closing manually" part doesn't want to work -->
          <div class="alert alert-warning alert-dismissable animif" role="alert">
            <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <p>{{warn.text}}</p>
          </div>
        </div>
        <div class="form-group">
          You're buying
          <input type="number" ng-model="form.mainBuynum" min="1">
          {{mainBuynum() == 1 ? selected.unittype.label : selected.unittype.plural}}
          <span ng-if="selected.stat('twin') > 1">(x{{selected.stat('twin')|bignum}} twins)</span>
          for
          <span ng-repeat="cost in selected.cost">
            <span ng-if="!$first && $last"> and </span>
            <span ng-class="{costNotMet:cost.val*mainBuynum() > cost.unit.count()}">{{cost.val*mainBuynum() | bignum}} {{cost.val*mainBuynum() == 1 ? cost.unit.unittype.label : cost.unit.unittype.plural}}</span><span ng-if="$last">.</span><span ng-if="!$last && selected.cost.length > 2">, </span>
          </span>
          <div class="row nogutter">
            <div class="nogutter" ng-class="{'col-sm-4':selected.maxCostMet() > 1}">
              <button ng-click="commands.buyUnit({unit:selected, num:mainBuynum(), ui:'selected'})" class="form-control unit-buy"  ng-disabled="!selected.isCostMet()">
                Buy {{unitBuyTotal(mainBuynum())|bignum}}
              </button>
            </div>
            <div class="col-sm-4 nogutter" title="25% of maximum you can pay for" ng-show="selected.maxCostMet(0.25) > 1">
              <button ng-click="commands.buyMaxUnit({unit:selected, percent:0.25, ui:'selected'})" class="form-control unit-buy">
                Buy {{selected.maxCostMet(0.25)*selected.stat('twin')|bignum}}
              </button>
            </div>
            <div class="nogutter" title="Maximum you can pay for" ng-class="{'col-sm-4':selected.maxCostMet(0.25) > 1, 'col-sm-8':!(selected.maxCostMet(0.25) > 1)}" ng-show="selected.maxCostMet() > 1">
              <button ng-click="commands.buyMaxUnit({unit:selected, percent: 1, ui:'selected'})" class="form-control unit-buy">
                Buy {{selected.maxCostMet()*selected.stat('twin')|bignum}}
              </button>
            </div>
          </div>
        </div>
      </div>
      <div ng-if="(visibleUpgrades = (selected.showparent ? selected.showparent.upgrades.list : selected.upgrades.list | filter:isVisible)).length > 0">
        <hr>
        <h4>Upgrades</h4>
        <ul class="list-unstyled">
          <li ng-repeat="upgrade in visibleUpgrades">
            <h5>{{upgrade.type.label}} ({{upgrade.count()}})</h5>
            <p title="{{upgrade.type.lol}}">{{upgrade.type.description}}</p>
            <p>
              Next upgrade costs
              <span ng-repeat="(name, cost) in upgrade.totalCost()">
                <span ng-if="!$first && $last"> and </span>
                <span ng-class="{costNotMet:cost.val > cost.unit.count()}">{{cost.val | bignum}} {{cost.val == 1 ? cost.unit.unittype.label : cost.unit.unittype.plural}}</span><span ng-if="$last">.</span><span ng-if="!$last && selected.cost.length > 2">, </span>
              </span>
            </p>

            <div class="row nogutter">
              <div class="nogutter" ng-class="{'col-sm-4':upgrade.maxCostMet() > 1}">
                <button ng-click="commands.buyUpgrade({upgrade:upgrade, num:1, ui:'selected'})" class="form-control unit-buy"  ng-disabled="!upgrade.isCostMet()">
                  Buy one
                </button>
              </div>
              <div class="col-sm-4 nogutter" title="25% of maximum you can pay for" ng-show="isUpgrade25Visible(upgrade)">
                <button ng-click="commands.buyMaxUpgrade({upgrade:upgrade, percent:0.25, ui:'selected'})" class="form-control unit-buy">
                  Buy {{upgrade.maxCostMet(0.25)|bignum}}
                </button>
              </div>
              <div class="nogutter" title="Maximum you can pay for" ng-class="{'col-sm-4':isUpgrade25Visible(upgrade), 'col-sm-8':!isUpgrade25Visible(upgrade)}" ng-show="upgrade.maxCostMet() > 1">
                <button ng-click="commands.buyMaxUpgrade({upgrade:upgrade, percent: 1, ui:'selected'})" class="form-control unit-buy">
                  Buy {{upgrade.maxCostMet()|bignum}}
                </button>
              </div>
            </div>
          </li>
        </ul>
      </div>
      <p ng-if="!visibleUpgrades">No upgrades available.</p>
      <p><a ng-click="select(null)">Back</a></p>
    </div>
  </div>
  <div class="col-sm-4 col-sm-pull-8" ng-class="{'hidden-xs':!!selected}">
    <ul ng-repeat="group in [0,1,2,3,4,5,6]" ng-if="visibleUnitGroup(group).length > 0" class="nav nav-pills nav-stacked unitgroup animif">
      <li ng-repeat="unit in visibleUnitGroup(group)" class="animif" ng-class="{active:selected===unit,costNotMet:!unit.isCostMet()}">
        <a ng-click="select(unit)" data-toggle="dropdown" title="{{costText(unit)}}">
          <span class="unitlabel titlecase">{{unit.unittype.label}}</span>
          <div class="badge">{{unit.count() | bignum}}</div>
        </a>
      </li>
    </ul>
  </div>
</div>
